name: Deploy Test

on:
    push:
        branches:
            - test

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            -   name: Checkout
                uses: actions/checkout@v2

            -   name: Create secrets.json for Django
                id: create-json
                uses: jsdaniell/create-json@1.1.2
                with:
                    name: secrets.json
                    json: ${{ secrets.SECRETS_TEST }}
                    dir: tmp/

            -   name: Login to docker
                uses: docker/login-action@v1
                with:
                    registry: ${{ secrets.SCW_DOCKER_REGISTRY }}
                    username: ${{ secrets.SCW_DOCKER_USERNAME }}
                    password: ${{ secrets.SCW_TOKEN }}

            -   name: Build the container
                run: |
                    docker build -t ${{ secrets.SCW_DOCKER_REGISTRY }}/lawandorga-backend-test:latest .
                    docker push ${{ secrets.SCW_DOCKER_REGISTRY }}/lawandorga-backend-test:latest

            -   name: Trigger a redeploy
                run: |
                    curl -X PATCH \
                      https://api.scaleway.com/containers/v1beta1/regions/fr-par/containers/48026603-6018-469f-bce8-43d7a8a6036c \
                      -H 'X-Auth-Token: ${{ secrets.SCW_TOKEN }}' \
                      -H 'Content-Type: application/json' \
                      -d '{ "redeploy": true }'


