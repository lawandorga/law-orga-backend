name: Commit Stage - Analyze Code With Sonarcloud

on:
  workflow_call:
    inputs:
      include_test_results:
        required: true
        type: boolean
    secrets:
      SONAR_TOKEN:
        required: true

jobs:
  scan:
    name: Scan
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set Up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - uses: actions/cache@v3
        id: cache-packages
        with:
          path: ${{ env.pythonLocation }}
          key: ${{ env.pythonLocation }}-${{ hashFiles('Pipfile') }}

      - name: Download Test Results
        if: ${{ inputs.include_test_results }}
        uses: actions/download-artifact@v3
        with:
          name: coverage

      - name: Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

